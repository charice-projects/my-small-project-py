import pandas as pd
import re
import os
import time
from tkinter import Tk, filedialog
import sys

# 尝试导入tqdm库，如果不存在则使用简单进度条
try:
    from tqdm import tqdm
    HAS_TQDM = True
except ImportError:
    HAS_TQDM = False
    print("提示：安装tqdm库可以获得更好的进度条显示 (pip install tqdm)")

# 江西手机号段前缀（主要号段，用于快速判断是否为江西号码）
jiangxi_prefixes = [
    '130', '131', '132', '133', '134', '135', '136', '137', '138', '139',
    '145', '147', '149', '150', '151', '152', '153', '155', '156', '157', '158', '159',
    '165', '166', '167', '170', '171', '172', '173', '174', '175', '176', '177', '178', '179',
    '180', '181', '182', '183', '184', '185', '186', '187', '188', '189',
    '191', '198', '199'
]

# 江西各城市手机号段数据库（前7位）- 已完善
jiangxi_city_prefixes = {
    # 南昌市 (0791)
    '1300620': '南昌', '1300621': '南昌', '1300720': '南昌', '1300721': '南昌', '1303720': '南昌', '1303721': '南昌',
    '1311780': '南昌', '1311781': '南昌', '1311782': '南昌', '1311783': '南昌', '1311790': '南昌', '1311791': '南昌',
    '1320700': '南昌', '1320701': '南昌', '1320702': '南昌', '1320703': '南昌', '1320704': '南昌', '1320705': '南昌',
    '1330700': '南昌', '1330701': '南昌', '1330702': '南昌', '1330703': '南昌', '1330704': '南昌', '1330705': '南昌',
    '1340700': '南昌', '1340701': '南昌', '1340702': '南昌', '1340703': '南昌', '1340704': '南昌', '1340705': '南昌',
    '1350700': '南昌', '1350701': '南昌', '1350702': '南昌', '1350703': '南昌', '1350704': '南昌', '1350705': '南昌',
    '1360700': '南昌', '1360701': '南昌', '1360702': '南昌', '1360703': '南昌', '1360704': '南昌', '1360705': '南昌',
    '1370700': '南昌', '1370701': '南昌', '1370702': '南昌', '1370703': '南昌', '1370704': '南昌', '1370705': '南昌',
    '1380700': '南昌', '1380701': '南昌', '1380702': '南昌', '1380703': '南昌', '1380704': '南昌', '1380705': '南昌',
    '1390700': '南昌', '1390701': '南昌', '1390702': '南昌', '1390703': '南昌', '1390704': '南昌', '1390705': '南昌',
    '1470700': '南昌', '1470701': '南昌', '1470702': '南昌', '1470703': '南昌', '1470704': '南昌', '1470705': '南昌',
    '1500700': '南昌', '1500701': '南昌', '1500702': '南昌', '1500703': '南昌', '1500704': '南昌', '1500705': '南昌',
    '1510700': '南昌', '1510701': '南昌', '1510702': '南昌', '1510703': '南昌', '1510704': '南昌', '1510705': '南昌',
    '1520700': '南昌', '1520701': '南昌', '1520702': '南昌', '1520703': '南昌', '1520704': '南昌', '1520705': '南昌',
    '1530700': '南昌', '1530701': '南昌', '1530702': '南昌', '1530703': '南昌', '1530704': '南昌', '1530705': '南昌',
    '1550700': '南昌', '1550701': '南昌', '1550702': '南昌', '1550703': '南昌', '1550704': '南昌', '1550705': '南昌',
    '1560700': '南昌', '1560701': '南昌', '1560702': '南昌', '1560703': '南昌', '1560704': '南昌', '1560705': '南昌',
    '1570700': '南昌', '1570701': '南昌', '1570702': '南昌', '1570703': '南昌', '1570704': '南昌', '1570705': '南昌',
    '1580700': '南昌', '1580701': '南昌', '1580702': '南昌', '1580703': '南昌', '1580704': '南昌', '1580705': '南昌',
    '1590700': '南昌', '1590701': '南昌', '1590702': '南昌', '1590703': '南昌', '1590704': '南昌', '1590705': '南昌',
    '1650700': '南昌', '1650701': '南昌', '1650702': '南昌', '1650703': '南昌', '1650704': '南昌', '1650705': '南昌',
    '1660700': '南昌', '1660701': '南昌', '1660702': '南昌', '1660703': '南昌', '1660704': '南昌', '1660705': '南昌',
    '1700700': '南昌', '1700701': '南昌', '1700702': '南昌', '1700703': '南昌', '1700704': '南昌', '1700705': '南昌',
    '1710700': '南昌', '1710701': '南昌', '1710702': '南昌', '1710703': '南昌', '1710704': '南昌', '1710705': '南昌',
    '1720700': '南昌', '1720701': '南昌', '1720702': '南昌', '1720703': '南昌', '1720704': '南昌', '1720705': '南昌',
    '1730700': '南昌', '1730701': '南昌', '1730702': '南昌', '1730703': '南昌', '1730704': '南昌', '1730705': '南昌',
    '1740700': '南昌', '1740701': '南昌', '1740702': '南昌', '1740703': '南昌', '1740704': '南昌', '1740705': '南昌',
    '1750700': '南昌', '1750701': '南昌', '1750702': '南昌', '1750703': '南昌', '1750704': '南昌', '1750705': '南昌',
    '1760700': '南昌', '1760701': '南昌', '1760702': '南昌', '1760703': '南昌', '1760704': '南昌', '1760705': '南昌',
    '1770700': '南昌', '1770701': '南昌', '1770702': '南昌', '1770703': '南昌', '1770704': '南昌', '1770705': '南昌',
    '1780700': '南昌', '1780701': '南昌', '1780702': '南昌', '1780703': '南昌', '1780704': '南昌', '1780705': '南昌',
    '1790700': '南昌', '1790701': '南昌', '1790702': '南昌', '1790703': '南昌', '1790704': '南昌', '1790705': '南昌',
    '1800700': '南昌', '1800701': '南昌', '1800702': '南昌', '1800703': '南昌', '1800704': '南昌', '1800705': '南昌',
    '1810700': '南昌', '1810701': '南昌', '1810702': '南昌', '1810703': '南昌', '1810704': '南昌', '1810705': '南昌',
    '1820700': '南昌', '1820701': '南昌', '1820702': '南昌', '1820703': '南昌', '1820704': '南昌', '1820705': '南昌',
    '1830700': '南昌', '1830701': '南昌', '1830702': '南昌', '1830703': '南昌', '1830704': '南昌', '1830705': '南昌',
    '1840700': '南昌', '1840701': '南昌', '1840702': '南昌', '1840703': '南昌', '1840704': '南昌', '1840705': '南昌',
    '1850700': '南昌', '1850701': '南昌', '1850702': '南昌', '1850703': '南昌', '1850704': '南昌', '1850705': '南昌',
    '1860700': '南昌', '1860701': '南昌', '1860702': '南昌', '1860703': '南昌', '1860704': '南昌', '1860705': '南昌',
    '1870700': '南昌', '1870701': '南昌', '1870702': '南昌', '1870703': '南昌', '1870704': '南昌', '1870705': '南昌',
    '1880700': '南昌', '1880701': '南昌', '1880702': '南昌', '1880703': '南昌', '1880704': '南昌', '1880705': '南昌',
    '1890700': '南昌', '1890701': '南昌', '1890702': '南昌', '1890703': '南昌', '1890704': '南昌', '1890705': '南昌',
    '1910700': '南昌', '1910701': '南昌', '1910702': '南昌', '1910703': '南昌', '1910704': '南昌', '1910705': '南昌',
    '1980700': '南昌', '1980701': '南昌', '1980702': '南昌', '1980703': '南昌', '1980704': '南昌', '1980705': '南昌',
    '1990700': '南昌', '1990701': '南昌', '1990702': '南昌', '1990703': '南昌', '1990704': '南昌', '1990705': '南昌',
    
    # 九江市 (0792)
    '1300722': '九江', '1300723': '九江', '1300724': '九江', '1300725': '九江', '1300726': '九江', '1300727': '九江',
    '1313360': '九江', '1313361': '九江', '1313362': '九江', '1313363': '九江', '1317790': '九江', '1317791': '九江',
    '1320706': '九江', '1320707': '九江', '1320708': '九江', '1320709': '九江', '1323790': '九江', '1323791': '九江',
    '1330706': '九江', '1330707': '九江', '1330708': '九江', '1330709': '九江', '1331700': '九江', '1331701': '九江',
    '1340706': '九江', '1340707': '九江', '1340708': '九江', '1340709': '九江', '1342660': '九江', '1342661': '九江',
    '1350706': '九江', '1350707': '九江', '1350708': '九江', '1350709': '九江', '1351790': '九江', '1351791': '九江',
    '1360706': '九江', '1360707': '九江', '1360708': '九江', '1360709': '九江', '1362700': '九江', '1362701': '九江',
    '1370706': '九江', '1370707': '九江', '1370708': '九江', '1370709': '九江', '1373290': '九江', '1373291': '九江',
    '1380706': '九江', '1380707': '九江', '1380708': '九江', '1380709': '九江', '1380350': '九江', '1380351': '九江',
    '1390706': '九江', '1390707': '九江', '1390708': '九江', '1390709': '九江', '1397020': '九江', '1397021': '九江',
    
    # 上饶市 (0793)
    '1300628': '上饶', '1300629': '上饶', '1300728': '上饶', '1300729': '上饶', '1303320': '上饶', '1303321': '上饶',
    '1313394': '上饶', '1313395': '上饶', '1313396': '上饶', '1313397': '上饶', '1317794': '上饶', '1317795': '上饶',
    '1320793': '上饶', '1330793': '上饶', '1340793': '上饶', '1350793': '上饶', '1360793': '上饶', '1370793': '上饶',
    '1380793': '上饶', '1390793': '上饶', '1470793': '上饶', '1500793': '上饶', '1510793': '上饶', '1520793': '上饶',
    '1530793': '上饶', '1550793': '上饶', '1560793': '上饶', '1570793': '上饶', '1580793': '上饶', '1590793': '上饶',
    '1650793': '上饶', '1660793': '上饶', '1700793': '上饶', '1710793': '上饶', '1720793': '上饶', '1730793': '上饶',
    '1740793': '上饶', '1750793': '上饶', '1760793': '上饶', '1770793': '上饶', '1780793': '上饶', '1790793': '上饶',
    '1800793': '上饶', '1810793': '上饶', '1820793': '上饶', '1830793': '上饶', '1840793': '上饶', '1850793': '上饶',
    '1860793': '上饶', '1870793': '上饶', '1880793': '上饶', '1890793': '上饶',
    
    # 抚州市 (0794)
    '1300624': '抚州', '1300625': '抚州', '1300626': '抚州', '1300627': '抚州', '1303322': '抚州', '1303323': '抚州',
    '1313398': '抚州', '1313399': '抚州', '1317796': '抚州', '1317797': '抚州', '1317798': '抚州', '1317799': '抚州',
    '1320794': '抚州', '1330794': '抚州', '1340794': '抚州', '1350794': '抚州', '1360794': '抚州', '1370794': '抚州',
    '1380794': '抚州', '1390794': '抚州', '1470794': '抚州', '1500794': '抚州', '1510794': '抚州', '1520794': '抚州',
    '1530794': '抚州', '1550794': '抚州', '1560794': '抚州', '1570794': '抚州', '1580794': '抚州', '1590794': '抚州',
    '1650794': '抚州', '1660794': '抚州', '1700794': '抚州', '1710794': '抚州', '1720794': '抚州', '1730794': '抚州',
    '1740794': '抚州', '1750794': '抚州', '1760794': '抚州', '1770794': '抚州', '1780794': '抚州', '1790794': '抚州',
    
    # 宜春市 (0795)
    '1300620': '宜春', '1300621': '宜春', '1300622': '宜春', '1300623': '宜春', '1303326': '宜春', '1303327': '宜春',
    '1311784': '宜春', '1311785': '宜春', '1311786': '宜春', '1311787': '宜春', '1317090': '宜春', '1317091': '宜春',
    '1320795': '宜春', '1330795': '宜春', '1340795': '宜春', '1350795': '宜春', '1360795': '宜春', '1370795': '宜春',
    '1380795': '宜春', '1390795': '宜春', '1470795': '宜春', '1500795': '宜春', '1510795': '宜春', '1520795': '宜春',
    '1530795': '宜春', '1550795': '宜春', '1560795': '宜春', '1570795': '宜春', '1580795': '宜春', '1590795': '宜春',
    
    # 吉安市 (0796)
    '1300622': '吉安', '1300623': '吉安', '1303328': '吉安', '1303329': '吉安', '1311788': '吉安', '1311789': '吉安',
    '1317790': '吉安', '1317791': '吉安', '1317792': '吉安', '1317793': '吉安', '1320796': '吉安', '1330796': '吉安',
    '1340796': '吉安', '1350796': '吉安', '1360796': '吉安', '1370796': '吉安', '1380796': '吉安', '1390796': '吉安',
    '1470796': '吉安', '1500796': '吉安', '1510796': '吉安', '1520796': '吉安', '1530796': '吉安', '1550796': '吉安',
    '1560796': '吉安', '1570796': '吉安', '1580796': '吉安', '1590796': '吉安',
    
    # 赣州市 (0797)
    '1303320': '赣州', '1303321': '赣州', '1303322': '赣州', '1303323': '赣州', '1303324': '赣州', '1303325': '赣州',
    '1313390': '赣州', '1313391': '赣州', '1313392': '赣州', '1313393': '赣州', '1317770': '赣州', '1317771': '赣州',
    '1320797': '赣州', '1330797': '赣州', '1340797': '赣州', '1350797': '赣州', '1360797': '赣州', '1370797': '赣州',
    '1380797': '赣州', '1390797': '赣州', '1470797': '赣州', '1500797': '赣州', '1510797': '赣州', '1520797': '赣州',
    '1530797': '赣州', '1550797': '赣州', '1560797': '赣州', '1570797': '赣州', '1580797': '赣州', '1590797': '赣州',
    
    # 景德镇市 (0798)
    '1300720': '景德镇', '1300721': '景德镇', '1303324': '景德镇', '1303325': '景德镇', '1313364': '景德镇', '1313365': '景德镇',
    '1317092': '景德镇', '1317093': '景德镇', '1320798': '景德镇', '1330798': '景德镇', '1340798': '景德镇', '1350798': '景德镇',
    '1360798': '景德镇', '1370798': '景德镇', '1380798': '景德镇', '1390798': '景德镇', '1470798': '景德镇', '1500798': '景德镇',
    '1510798': '景德镇', '1520798': '景德镇', '1530798': '景德镇', '1550798': '景德镇', '1560798': '景德镇', '1570798': '景德镇',
    '1580798': '景德镇', '1590798': '景德镇',
    
    # 萍乡市 (0799)
    '1300724': '萍乡', '1300725': '萍乡', '1303328': '萍乡', '1303329': '萍乡', '1313366': '萍乡', '1313367': '萍乡',
    '1317094': '萍乡', '1317095': '萍乡', '1320799': '萍乡', '1330799': '萍乡', '1340799': '萍乡', '1350799': '萍乡',
    '1360799': '萍乡', '1370799': '萍乡', '1380799': '萍乡', '1390799': '萍乡', '1470799': '萍乡', '1500799': '萍乡',
    '1510799': '萍乡', '1520799': '萍乡', '1530799': '萍乡', '1550799': '萍乡', '1560799': '萍乡', '1570799': '萍乡',
    '1580799': '萍乡', '1590799': '萍乡',
    
    # 新余市 (0790)
    '1300726': '新余', '1300727': '新余', '1303622': '新余', '1303623': '新余', '1313368': '新余', '1313369': '新余',
    '1317096': '新余', '1317097': '新余', '1320790': '新余', '1330790': '新余', '1340790': '新余', '1350790': '新余',
    '1360790': '新余', '1370790': '新余', '1380790': '新余', '1390790': '新余', '1470790': '新余', '1500790': '新余',
    '1510790': '新余', '1520790': '新余', '1530790': '新余', '1550790': '新余', '1560790': '新余', '1570790': '新余',
    '1580790': '新余', '1590790': '新余',
    
    # 鹰潭市 (0701)
    '1300728': '鹰潭', '1300729': '鹰潭', '1303626': '鹰潭', '1303627': '鹰潭', '1313370': '鹰潭', '1313371': '鹰潭',
    '1320701': '鹰潭', '1330701': '鹰潭', '1340701': '鹰潭', '1350701': '鹰潭', '1360701': '鹰潭', '1370701': '鹰潭',
    '1380701': '鹰潭', '1390701': '鹰潭', '1470701': '鹰潭', '1500701': '鹰潭', '1510701': '鹰潭', '1520701': '鹰潭',
    '1530701': '鹰潭', '1550701': '鹰潭', '1560701': '鹰潭', '1570701': '鹰潭', '1580701': '鹰潭', '1590701': '鹰潭'
}

def identify_phone_location(phone_number):
    """
    识别单个电话号码归属地
    返回格式: 城市名称 或 "江西其他" 或 "省外" 或 "无效号码"
    """
    # 转换为字符串并清理非数字字符
    phone_str = str(phone_number)
    clean_phone = re.sub(r'\D', '', phone_str)
    
    # 检查是否为11位手机号
    if len(clean_phone) != 11:
        return "无效号码"
    
    # 提取前3位和前7位
    prefix_3 = clean_phone[:3]
    prefix_7 = clean_phone[:7]
    
    # 检查是否为江西号码
    if prefix_3 in jiangxi_prefixes:
        # 检查是否能精确到市级
        if prefix_7 in jiangxi_city_prefixes:
            return jiangxi_city_prefixes[prefix_7]
        else:
            return "江西其他"
    else:
        return "省外"

def extract_phone_numbers(cell_content):
    """
    从单元格内容中提取所有电话号码
    支持多种分隔符：空格、逗号、分号、顿号、斜杠等
    """
    if pd.isna(cell_content) or cell_content == "":
        return []
    
    # 转换为字符串
    content_str = str(cell_content)
    
    # 使用正则表达式提取所有可能的11位数字序列
    potential_numbers = re.findall(r'\b1[3-9]\d{9}\b', content_str)
    
    # 过滤出有效的手机号（以1开头，第二位是3-9的11位数字）
    valid_numbers = []
    for num in potential_numbers:
        if len(num) == 11 and num[0] == '1' and num[1] in '3456789':
            valid_numbers.append(num)
    
    return valid_numbers

def process_multiple_phones(cell_content):
    """
    处理包含多个电话号码的单元格
    返回格式化的归属地信息字符串，所有信息在一个单元格内。
    """
    phone_numbers = extract_phone_numbers(cell_content)
    
    if not phone_numbers:
        return "无有效号码"
    
    location_list = []
    
    for phone in phone_numbers:
        location = identify_phone_location(phone)
        location_list.append(location)
    
    # 使用中文分号分隔，所有结果在一个单元格内
    return "；".join(location_list)

def simple_progress_bar(iteration, total, prefix='', suffix='', length=50, fill='█'):
    """
    简单文本进度条
    """
    percent = ("{0:.1f}").format(100 * (iteration / float(total)))
    filled_length = int(length * iteration // total)
    bar = fill * filled_length + '-' * (length - filled_length)
    print(f'\r{prefix} |{bar}| {percent}% {suffix}', end='\r')
    # 如果完成，打印新行
    if iteration == total: 
        print()

def select_file():
    """
    选择Excel文件
    """
    root = Tk()
    root.withdraw()  # 隐藏主窗口
    
    file_path = filedialog.askopenfilename(
        title="请选择Excel文件",
        filetypes=[("Excel files", "*.xlsx *.xls"), ("All files", "*.*")]
    )
    
    return file_path

def select_save_path(default_filename):
    """
    选择保存路径
    """
    root = Tk()
    root.withdraw()  # 隐藏主窗口
    
    save_path = filedialog.asksaveasfilename(
        title="请选择保存位置",
        initialfile=default_filename,
        filetypes=[("Excel files", "*.xlsx"), ("All files", "*.*")],
        defaultextension=".xlsx"
    )
    
    return save_path

def process_excel_file(file_path, phone_column, output_file=None):
    """
    处理Excel文件中的电话号码
    """
    try:
        # 读取Excel文件
        print("正在读取Excel文件...")
        start_time = time.time()
        df = pd.read_excel(file_path)
        load_time = time.time() - start_time
        print(f"文件读取完成，共 {len(df)} 行数据，耗时 {load_time:.2f} 秒")
        
        # 检查指定的列是否存在
        if phone_column not in df.columns:
            print(f"错误：列 '{phone_column}' 不存在于文件中")
            print(f"可用列：{list(df.columns)}")
            return None
        
        # 找到电话号码列的索引
        phone_col_index = df.columns.get_loc(phone_column)
        
        # 在电话号码列右侧插入归属地列
        df.insert(phone_col_index + 1, '归属地', '')
        
        print("正在识别电话号码归属地...")
        
        # 统计信息
        total_phones = 0
        jiangxi_phones = 0
        outside_phones = 0
        invalid_phones = 0
        city_counts = {}
        
        # 使用进度条处理数据
        if HAS_TQDM:
            # 使用tqdm进度条
            for index, row in tqdm(df.iterrows(), total=len(df), desc="处理进度"):
                cell_content = row[phone_column]
                location_str = process_multiple_phones(cell_content)
                
                df.at[index, '归属地'] = location_str
                
                # 统计
                phones_in_cell = extract_phone_numbers(cell_content)
                total_phones += len(phones_in_cell)
                
                for phone in phones_in_cell:
                    location = identify_phone_location(phone)
                    if location == "省外":
                        outside_phones += 1
                    elif location == "无效号码":
                        invalid_phones += 1
                    elif location == "江西其他":
                        jiangxi_phones += 1
                        if "江西其他" in city_counts:
                            city_counts["江西其他"] += 1
                        else:
                            city_counts["江西其他"] = 1
                    elif location != "无有效号码":
                        jiangxi_phones += 1
                        if location in city_counts:
                            city_counts[location] += 1
                        else:
                            city_counts[location] = 1
        else:
            # 使用简单进度条
            total_rows = len(df)
            for index, row in df.iterrows():
                cell_content = row[phone_column]
                location_str = process_multiple_phones(cell_content)
                
                df.at[index, '归属地'] = location_str
                
                # 统计
                phones_in_cell = extract_phone_numbers(cell_content)
                total_phones += len(phones_in_cell)
                
                for phone in phones_in_cell:
                    location = identify_phone_location(phone)
                    if location == "省外":
                        outside_phones += 1
                    elif location == "无效号码":
                        invalid_phones += 1
                    elif location == "江西其他":
                        jiangxi_phones += 1
                        if "江西其他" in city_counts:
                            city_counts["江西其他"] += 1
                        else:
                            city_counts["江西其他"] = 1
                    elif location != "无有效号码":
                        jiangxi_phones += 1
                        if location in city_counts:
                            city_counts[location] += 1
                        else:
                            city_counts[location] = 1
                
                # 每处理10行更新一次进度条，或者最后一行
                if index % 10 == 0 or index == total_rows - 1:
                    simple_progress_bar(index + 1, total_rows, prefix='进度', suffix=f'已处理 {index + 1}/{total_rows}')
        
        process_time = time.time() - start_time - load_time
        print(f"\n归属地识别完成，耗时 {process_time:.2f} 秒")
        
        # 显示统计结果
        print("\n" + "="*60)
        print("处理完成！统计结果：")
        print("="*60)
        print(f"总单元格数：{len(df)} 个")
        print(f"总号码数量：{total_phones} 个")
        if total_phones > 0:
            print(f"江西号码：{jiangxi_phones} 个 ({jiangxi_phones/total_phones*100:.1f}%)")
            if jiangxi_phones > 0:
                print("江西各城市分布：")
                for city, count in sorted(city_counts.items(), key=lambda x: x[1], reverse=True):
                    percentage = count/jiangxi_phones*100
                    print(f"  {city}：{count} 个 ({percentage:.1f}%)")
            print(f"省外号码：{outside_phones} 个 ({outside_phones/total_phones*100:.1f}%)")
            print(f"无效号码：{invalid_phones} 个 ({invalid_phones/total_phones*100:.1f}%)")
        print("="*60)
        
        # 保存结果
        if output_file is None:
            # 默认保存路径：原文件同目录，文件名添加后缀
            base_name = os.path.splitext(file_path)[0]
            output_file = f"{base_name}_归属地识别结果.xlsx"
        
        print(f"正在保存结果到：{output_file}")
        save_start = time.time()
        df.to_excel(output_file, index=False)
        save_time = time.time() - save_start
        print(f"保存完成！耗时 {save_time:.2f} 秒")
        
        total_time = time.time() - start_time
        print(f"\n总处理时间：{total_time:.2f} 秒")
        
        return df
        
    except Exception as e:
        print(f"处理文件时出错：{e}")
        import traceback
        traceback.print_exc()
        return None

def show_welcome_message():
    """
    显示欢迎和使用说明
    """
    message = """
    ===========================================
            Excel电话号码归属地识别工具
    ===========================================
    
    功能说明：
    1. 自动识别Excel中的电话号码归属地
    2. 支持单个单元格内多个电话号码（用空格、逗号、分号等分隔）
    3. 精确识别江西省内各城市号码（南昌、九江、上饶、抚州、宜春、吉安、赣州、景德镇、萍乡、新余、鹰潭）
    4. 无法识别的江西号码显示为"江西其他"
    5. 省外号码统一标记为"省外"
    6. 在电话号码列右侧插入归属地列，所有信息在一个单元格内
    
    使用步骤：
    1. 选择包含电话号码的Excel文件
    2. 输入电话号码所在列的名称
    3. 选择保存结果的位置（可选）
    4. 程序自动识别并生成结果文件
    
    输出格式：
    - 在电话号码列右侧插入一列："归属地"
    - 多个号码的归属地用中文分号分隔
    
    支持格式：
    - Excel文件 (.xlsx, .xls)
    - 电话号码格式：支持各种分隔符，程序会自动提取
    
    注意：请确保Excel文件中包含正确的电话号码列
    ===========================================
    """
    print(message)

def main():
    """
    主函数
    """
    # 设置控制台编码为UTF-8，确保中文显示正常
    if sys.platform == "win32":
        import io
        sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
        sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')
    
    show_welcome_message()
    
    # 选择Excel文件
    print("步骤1：请选择Excel文件...")
    file_path = select_file()
    
    if not file_path:
        print("未选择文件，程序退出。")
        return
    
    print(f"已选择文件：{file_path}")
    
    # 显示文件中的列
    try:
        df_preview = pd.read_excel(file_path, nrows=1)
        print(f"\n文件中的列：{list(df_preview.columns)}")
    except Exception as e:
        print(f"读取文件失败：{e}")
        return
    
    # 获取电话号码列名
    print("\n步骤2：请输入电话号码列名")
    phone_column = input("请输入包含电话号码的列名：").strip()
    
    # 选择保存路径
    print("\n步骤3：选择保存位置（直接按回车使用默认路径）")
    default_filename = os.path.splitext(os.path.basename(file_path))[0] + "_归属地识别结果.xlsx"
    save_path = select_save_path(default_filename)
    
    if not save_path:
        save_path = None
        print("将使用默认保存路径")
    
    # 处理文件
    print("\n开始处理文件...")
    result_df = process_excel_file(file_path, phone_column, save_path)
    
    if result_df is not None:
        print("\n处理完成！")
        input("按回车键退出程序...")
    else:
        print("\n处理失败，请检查错误信息。")
        input("按回车键退出程序...")

if __name__ == "__main__":
    main()